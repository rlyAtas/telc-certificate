# SETUP: детальная установка и локальная разработка

## 1. Назначение документа
Этот документ описывает полный путь локального запуска проекта `telc-certificate`:
- установка зависимостей;
- настройка окружения;
- подготовка базы данных;
- запуск в режиме разработки;
- проверка базового сценария и типовые проблемы.

## 2. Требования к окружению
Перед началом убедитесь, что установлены:
- `Node.js` (актуальная LTS-версия);
- `npm`;
- `git`.

Для полноценного локального сценария также нужны:
- аккаунт/ключ `Resend` (отправка писем подтверждения);
- `ngrok` authtoken (для dev-режима, так как приложение поднимает ngrok-туннель).

## 3. Установка проекта
### 3.1 Клонирование и переход в директорию
```bash
git clone <URL_РЕПОЗИТОРИЯ>
cd telc-certificate
```

### 3.2 Установка зависимостей
```bash
npm install
```

### 3.3 Генерация Prisma Client
```bash
npx prisma generate
```

## 4. Настройка переменных окружения
### 4.1 Создать `.env`
```bash
cp .env.example .env
```

### 4.2 Заполнить `.env`
Пример минимальной конфигурации:

```env
PORT=3000
PUBLIC_BASE_URL=http://localhost:3000
DATABASE_URL=file:./prisma/dev.db
SUPPORT_EMAIL=support@example.com

RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxxxx
SMTP_FROM=telc Zertifikatsprufung <something@resend.dev>

LOG_LEVEL=debug
```

Дополнительно для `development`:
- `NGROK_AUTHTOKEN` — токен ngrok (используется библиотекой `@ngrok/ngrok`).

Рекомендации:
- для локального теста без внешнего домена можно оставить `PUBLIC_BASE_URL=http://localhost:3000`;
- для проверки e-mail ссылок через интернет используйте адрес ngrok и обновите `PUBLIC_BASE_URL`.

## 5. Подготовка базы данных
### 5.1 Применить миграции
```bash
npm run migrate
```

Эта команда:
- читает `DATABASE_URL` из `.env`;
- применяет SQL-миграции из `prisma/migrations`;
- создаёт/обновляет SQLite-базу.

### 5.2 Проверить, что БД доступна
Быстрая проверка:
- команда `npm run migrate` завершилась без ошибок;
- файл базы данных (например, `prisma/dev.db`) появился на диске.

## 6. Запуск локальной разработки
### 6.1 Старт приложения
```bash
npm run dev
```

В этом режиме:
- запускается `nodemon`;
- приложение стартует через `tsx` (`src/server.ts`);
- поднимается cron-задача проверки сертификатов (каждые 5 секунд);
- в `NODE_ENV=development` приложение пытается поднять ngrok-туннель.

### 6.2 Что проверить в логах
Ожидаемые сообщения:
- сервер запущен на `PORT`;
- выведен публичный URL ngrok;
- нет ошибок подключения к БД и отправки почты.

## 7. Базовый локальный сценарий проверки
1. Откройте `http://localhost:3000`.
2. Заполните форму и отправьте заявку.
3. Откройте письмо подтверждения на почте.
4. Перейдите по ссылке `/confirm/:token`.
5. На странице подтверждения откройте ссылку `/status/:publicToken`.
6. Убедитесь, что статус меняется согласно процессу обработки.
